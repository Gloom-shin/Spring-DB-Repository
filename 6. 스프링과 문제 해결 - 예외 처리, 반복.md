# ìŠ¤í”„ë§ì˜ ê°•ì˜ ë¦¬ë·°ğŸ“½

> LoadMap Part : ìŠ¤í”„ë§ DB 1í¸ - ë°ì´í„° ì ‘ê·¼ í•µì‹¬ ì›ë¦¬ - 2022-05-15  
> Section : 6.ìŠ¤í”„ë§ê³¼ ë¬¸ì œ í•´ê²° - ì˜ˆì™¸ì²˜ë¦¬, ë°˜ë³µ   
> CreateDate : 2022.11.07  
> UpdateDate : 2022.11.

## ì‚¬ìš©í•œ ìŠ¤í™

> Spring Boot ë²„ì „ : Spring Boot 2.7.3  
> Java ë²„ì „ : java 11    
> Gradle ë²„ì „: gradle-7.5

<br></br>
<br></br>

# 1. ì²´í¬ ì˜ˆì™¸ì™€ ì¸í„°í˜ì´ìŠ¤
 - ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´, êµ¬í˜„ê¸°ìˆ ì„ ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆê²Œ í•´ì•¼í•œë‹¤. 

### ì˜ˆì‹œ ì½”ë“œ
```java
public interface MemberRepository {
     Member save(Member member);
     Member findById(String memberId);
     void update(String memberId, int money);
     void delete(String memberId);
}
```
 - í•˜ì§€ë§Œ, ì™œëƒí•˜ë©´ SQLException ê°™ì€ ì²´í¬ ì˜ˆì™¸ì´ê¸° ë•Œë¬¸ì—, ë¬¸ì œê°€ ë°œìƒí•œë‹¤. 

```java
import java.sql.SQLException; // ì¢…ì†ì ì´ê²Œ ë¨

public interface MemberRepositoryEx {
     Member save(Member member) throws SQLException;
     Member findById(String memberId) throws SQLException;
     void update(String memberId, int money) throws SQLException;
     void delete(String memberId) throws SQLException;
}
```
 - ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œì— í•´ë‹¹ ì²´í¬ ì˜ˆì™¸ë¥¼ ë˜ì§ˆ ìˆ˜ ìˆëŠ” `throws SQLException` ê°€ ìˆì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
 - ì¦‰, ìˆœìˆ˜í•´ì§€ì§€ ì•Šì•„ì§„ë‹¤.
> ê·¸ë˜ì„œ, ê° êµ¬í˜„ê¸°ìˆ ë“¤ì€ ëŸ°íƒ€ì„ì˜ˆì™¸ë¥¼  ì ìš©í•˜ê²Œ ëœë‹¤.
> ê·¸ëŸ¼ ë³„ë„ë¡œ ë˜ì§€ëŠ” throwì²˜ë¦¬ê°€ ì—†ì–´ì ¸ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì¼ í•„ìš”ê°€ ì—†ì–´ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤.


# 2. ëŸ°íƒ€ì„ ì˜ˆì™¸ ì ìš©

### ì˜ˆì‹œ ì½”ë“œ
- DB ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë°”ê¿”ì£¼ëŠ” ì½”ë“œì´ë‹¤.
```java

public class MyDBException extends RuntimeException{
    public MyDBException() {
    }

    public MyDBException(String message) {
        super(message);
    }

    public MyDBException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDBException(Throwable cause) {
        super(cause);
    }
}
```

- ë•ë¶„ì—, ìœ„ì—ì„œ ëª»í•˜ë˜, ì¢…ì†ì ì´ì§€ ì•ŠëŠ” Repository ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
```java
public interface MemberRepository {
     Member save(Member member);
     Member findById(String memberId);
     void update(String memberId, int money);
     void delete(String memberId);
}
```
- ê·¸ëŸ¼ ì´ì œ êµ¬í˜„ë˜ëŠ” repositoryëŠ” ìœ„ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì† ë°›ê³  DI ì‚¬ìš©í•˜ë©´ ì˜ˆì™¸ ëˆ„ìˆ˜ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
### í…ŒìŠ¤íŠ¸ ì½”ë“œ 
- [ ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°, SQLException ì œê±°í•œ Repositoryì½”ë“œ](/practice_code/repository/MemberRepositoryV4_1.java)
- [ ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°, SQLException ì œê±°í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ](/test_code/service/MemberServiceV4Test.java)


# 3. ë°ì´í„° ì ‘ê·¼ ì˜ˆì™¸ ì§ì ‘ ë§Œë“¤ê¸° 
> ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ì— ë”°ë¼ì„œ íŠ¹ì • ì˜ˆì™¸ëŠ” ë³µêµ¬í•˜ê³  ì‹¶ì„ ìˆ˜ë„ ìˆë‹¤.   
> ì˜ˆë¥¼ ë“¤ì–´ì„œ   
> íšŒì› ê°€ì…ì‹œ DBì— ì´ë¯¸ ê°™ì€ IDê°€ ìˆìœ¼ë©´ ID ë’¤ì— ìˆ«ìë¥¼ ë¶™ì—¬ì„œ ìƒˆë¡œìš´ IDë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤ê³  ê°€ì •í•´ë³´ì.
## ì˜ˆì‹œ ìƒí™© 
> IDë¥¼ hello ë¼ê³  ê°€ì… ì‹œë„ í–ˆëŠ”ë°, ì´ë¯¸ ê°™ì€ ì•„ì´ë””ê°€ ìˆìœ¼ë©´ hello12345 ì™€ ê°™ì´ ë’¤ì— ì„ì˜ì˜ ìˆ«ìë¥¼ ë¶™ì—¬ì„œ ê°€ì…í•˜ëŠ” ê²ƒì´ë‹¤.
 - ì´ê²½ìš°, DBì— ì €ì¥í• ë•Œ ì´ë¯¸ ê°™ì€ IDê°€ ìˆë‹¤ë©´, ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì˜¤ë¥˜ì½”ë“œë¥¼ ë°˜í™˜í•˜ê³ 
   - ì´ ì˜¤ë¥˜ ì½”ë“œë¥¼ ë°›ì€ JDBCë“œë¼ì´ë²„ëŠ” `SQLException`ì„ ë˜ì§€ë‹¤.
   - ê·¸ë¦¬ê³  ì´ `SQLException`ì€ errorCodeì„ ê°€ì§€ê³  ìˆë‹¤.
 - ì´ ì˜¤ë¥˜ì½”ë“œë¥¼ í™œìš©í•˜ì—¬, ì¤‘ë³µëœ IDê°€ ìˆì„ ì˜ˆì™¸ë¥¼ ë”°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì´ë‹¤

<br>

### ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ ì½”ë“œ íë¦„ 

<p align="center"><img src="https://user-images.githubusercontent.com/104331549/200214906-594acfd4-0dc8-46f4-9ef3-54068c5faf12.png" width="80%"></p>


- H2 ë°ì´í„°ë² ì´ìŠ¤ì˜ ê²½ìš°, í‚¤ì¤‘ë³µ ì˜¤ë¥˜ ì½”ë“œëŠ” `23505`ì´ë‹¤.
      - SQL ë¬¸ë²•ì˜¤ë¥˜ëŠ” `42000`
      - ì´ì²˜ëŸ¼ ì˜¤ë¥˜ ì½”ë“œë¡œ ì¸í•´, ì›í•˜ëŠ” ì˜¤ë¥˜ë¥¼ í•¸ë“œë§ì´ ê°€ëŠ¥í•´ì§„ë‹¤.
      - [H2 ì˜¤ë¥˜ì½”ë“œ ë¦¬ìŠ¤íŠ¸](https://www.h2database.com/javadoc/org/h2/api/ErrorCode.html)
> ì°¸ê³ ë¡œ ê°™ì€ ì˜¤ë¥˜ì—¬ë„ ê°ê°ì˜ ë°ì´í„°ë² ì´ìŠ¤ë§ˆë‹¤ ì •ì˜ëœ ì˜¤ë¥˜ ì½”ë“œê°€ ë‹¤ë¥´ë‹¤.   
> **í‚¤ ì¤‘ë³µ ì˜¤ë¥˜ ì½”ë“œ**  
> H2 DB: 2350  
> MySQL: 1062


<br>

### ì˜ˆì‹œ ì½”ë“œ
- ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ì•ì„œ ë°°ìš´ ê²ƒ ì²˜ëŸ¼ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì˜ˆì™¸ë¥¼ ë³€í™˜í•´ì„œ ë˜ì§€ë©´ ëœë‹¤
  - SQLException -> MyDuplicateKeyException
  - MyDBExceptionì„ ìƒì† ë°›ëŠ” ì˜ˆì™¸í´ë˜ìŠ¤ë¡œ, í‚¤ê°€ ì¤‘ë³µë  ë•Œ MyDuplicateKeyë¡œ ë³„ë„ë¡œ ì˜ˆì™¸ ì²˜ë¦¬ í•  ìˆ˜ ìˆê² ë” ë§Œë“  êµ¬í˜„ì²´ì´ë‹¤.
- ì´ ì˜ˆì™¸ëŠ” ìš°ë¦¬ê°€ ì§ì ‘ ë§Œë“  ê²ƒì´ê¸° ë•Œë¬¸ì—, JDBCë‚˜ JPA ê°™ì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•Šë‹¤
```java
public class MyDuplicateKeyException extends  MyDBException{
    public MyDuplicateKeyException() {
    }

    public MyDuplicateKeyException(String message) {
        super(message);
    }

    public MyDuplicateKeyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDuplicateKeyException(Throwable cause) {
        super(cause);
    }
}
```
 - ì˜ˆì™¸ë¥¼ ë³€í™˜í•˜ëŠ” ì‘ì—…ì„ í•˜ëŠ” ë ˆí¬ì§€í¬ë¦¬ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
   - `e.getErrorCode()`  : ì—ëŸ¬ì˜ ì˜¤ë¥˜ ì½”ë“œë¥¼ ë°˜í™˜í•œë‹¤.
```java
public class ExTranslatorV1Test {
    // ..ìƒëµ
    // ì‹¤ì œë¡œ, ì˜ˆì™¸ë¥¼ ë³€ê²½í•˜ëŠ” ë¶€ë¶„ì¸ Repository íŒŒíŠ¸ë¥¼ ë³´ë©´
    @RequiredArgsConstructor
    static class Repository {
        private final DataSource dataSource;

        public Member save(Member member) {
            String sql = "insert into member(member_id, money) value(?,?)";
            Connection con = null;
            PreparedStatement pstmt = null;

            try {
                con = dataSource.getConnection();
                pstmt = con.prepareStatement(sql);
                pstmt.setString(1, member.getMemberId());
                pstmt.setInt(2, member.getMoney());
                pstmt.executeUpdate();
                return member;
            } catch (SQLException e) {
                //h2 db
                if (e.getErrorCode() == 23505) { // ì˜¤ë¥˜ì½”ë“œë¥¼ í™•ì¸í•˜ì—¬ ë³„ë„ ì²˜ë¦¬
                    throw new MyDuplicateKeyException(e);
                }
                throw new MyDBException(e); // ê·¸ì™¸ì—” ê·¸ëŒ€ë¡œ ë˜ì§„ë‹¤.
            } finally {
                JdbcUtils.closeStatement(pstmt);
                JdbcUtils.closeConnection(con);
            }
        }
    }
}
```
- ê·¸ë¦¬ê³  ë°˜í™˜ëœ ì—ëŸ¬ì¤‘ íŠ¹ì • ì—ëŸ¬ë§Œ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```java
public class ExTranslatorV1Test {
    // ..ìƒëµ
    @RequiredArgsConstructor
    static class Service {
        private final Repository repository;

        public void create(String memberId) {
            try {
                repository.save(new Member(memberId, 0));
                log.info("saveId={}", memberId);
            } catch (MyDuplicateKeyException e) {
                log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
                String retryId = generateNewId(memberId);
                repository.save(new Member(retryId, 0));
            } catch (MyDBException e) {
                log.info("ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
                throw e;
            }
        }

        private String generateNewId(String memberId) {
            return memberId + new Random().nextInt(1000);
        }

    }
}
```

### ì°¸ê³  ë§í¬
- í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì½”ë“œë¥¼ ì…ë ¥í•˜ëŠ” ê³¼ì •ì—ì„œ, `Syntax error in SQL statement` ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤. 
  - ì´ìœ ëŠ” SQL ëª…ë ¹ì–´ì—ì„œ, valueë¡œ ì…ë ¥í•œê²Œ ì´ìœ ì˜€ë‹¤. 
  - ì–´ë””ì—ì„œëŠ” value ë¡œ ì‚¬ìš©í•´ë„ ê°€ëŠ¥ì€ í•˜ì§€ë§Œ, ëŒ€ë¶€ë¶„ valuesë¡œ ë°”ë€Œì–´ì„œ valuesë¥¼ ì“°ë„ë¡ í•˜ì.
  - [insert into value, values ì°¨ì´](https://stackoverflow.com/questions/17445583/what-is-difference-between-insert-value-and-insert-values-in-mysql-statement)