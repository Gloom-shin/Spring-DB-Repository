# 스프링 DB 강의 리뷰📽
> LoadMap Part : 스프링 DB 1편 - 데이터 접근 핵심 원리 - 2022-05-15  
> Section : 3.트랜잭션 이해  
> CreateDate : 2022.10.31
> UpdateDate :


## 사용한 스펙
> Spring Boot 버전 : Spring Boot 2.7.3  
> Java 버전 : java 11    
> Gradle 버전: gradle-7.5

### 목차

<br></br>
### IntelliJ 단축키

<br></br>
<br></br>
# 1. 트랜잭션의 개념
> 데이터를 저장할 때 단순히 파일에 저장해도 되지만, 데이터베이스에 저장하는 이유는 무엇일까?
 - 여러가지 이유가 있지만, 가장 대표적인 이유는 데이터베이스의 트랜잭션 지원 때문이다. 
 - 대표적인 예시로 1번 -> 2번 계좌이체를 예시로 드는데, 중간에 하나라도 실패하면 거래 전의 상태로 되돌아 갈수 있어야한다.
   - 모든 작업이 성공해서 데이터베이스에 정상 반영하는 것 : Commit(커밋)
   - 작업 중 하나라도 실패해서 거래 이전으로 되돌리는 것 : Rollback(롤백)

## 트랜잭션 ACID
 - 트랜잭션은 4가지 ACID를 보장해야한다.
### 원자성(Atomicity)
 - 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업인 것처럼 모두 성공 하거나 모두 실패해야 한다
### 일관성(Consistency)
 - 모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 
   - 예를 들어 데이터베이스에서 정한 무결성 제약 조건을 항상 만족해야 한다.
### 격리성(Isolation)
 - 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다
   - 예를 들어 동시에 같은 데이터를 수정하지 못하도록 해야 한다
   - 격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준(Isolation level)을 선택할 수 있다.
### 지속성(Durability)
 - 트랜잭션을 성공적으로 끝내면 그 결과가 항상 기록되어야 한다.
 - 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다

### 트랜잭션 격리 수준 - Isolation level
- 트랜잭션은 위 4가지를 보장해야되지만, 문제는 격리성에 있다. 
  - 격리성을 완벽히 보장하려면 거의 순서대로 실행해야되는데, 이경우 동시 처리 성능이 매우 나빠진다. 
  - 그래서, 상황에 따라 격리성의 정도를 변화할 수 있게 했는데, ANSI표준은 격리수준은 4단계로 나누어 정의한다.
  
1. READ UNCOMMITED(커밋되지 않은 읽기)
2. READ COMMITTED(커밋된 읽기)
3. REPEATABLE READ(반복 가능한 읽기)
4. SERIALIZABLE(직렬화 가능)


<br></br>
<br></br>

# 데이터베이스 연결 구조와 DB 세션
 - 트랜잭션을 더 자세히 이해하기 전, 데이터베이스 서버 연결구조와 DB세션에 대해 알고 있어야 한다. 

<p align="center"><img src="https://user-images.githubusercontent.com/104331549/198901632-d9fe51f3-0675-4ff1-94f4-b9b0ecc4d46b.png" width="80%"></p>

- 답은 간단하다, DB 접근 툴 같은 클라이언트를 사용해서 데이터베이스에 접근한다. 
- 그럼 클라이언트와 데이터베이스 커넥션을 맺게되는데, 이때 데이터베이스 서버내부에는 세션을 만든다.
- 그리고  해당 커넥션을 통한 모든 요청은 세션을 통해서 실행된다. 
- 즉, SQL을 전달하면 현재 커넥션에 연결된 세션이 SQL을 실행시킨다는 것이다. 
  - 세션은 트랜잭션을 시작하고, 종료(커밋/롤백)한다.
  - 사용자가 커넥션을 닫거나, DBA(DBadmin)가 세션을 강제로 종료하면 종료된다. 
- 커넥션 풀도 이와 같은 맥락이다.

<br></br>
<br></br>

# 트랜젝션 - DB 개념 이해 
- 데이터 변경 쿼리를 실행하고 데이터베이스에 그 결과를 반영하려면 커밋 명령어인 commit 을 호출하고, 결과를 반영하고 싶지 않으면 롤백 명령어인 rollback 을 호출하면 된다.
- 커밋을 호출하기 전까지는 임시로 데이터를 저장하는 것이다. 따라서 해당 트랜잭션을 시작한 세션(사용자)에게만 변경 데이터가 보이고 다른 세션(사용자)에게는 변경 데이터가 보이지 않는다.
- 처음 데이터상태는 아래와 같다고 가정하고, 세션을 2개가 만들어 졌다.
<p align="center"><img src="https://user-images.githubusercontent.com/104331549/198904496-4b05b901-d52e-41b0-b94f-ce0160c84a1c.png" width="80%"></p>

- 세션1, 세션2 둘다 가운데 있는 기본 테이블을 조회하면 해당 데이터가 그대로 조회된다.
<p align="center"><img src="https://user-images.githubusercontent.com/104331549/198904501-a0a78bf8-0b74-4505-8d7a-80ce9dff4810.png" width="80%"></p>

- 세션1에서 트랜잭션을 시작하면서 신규회원1을 DB에 추가했다. 하지만 커밋하기 전에 세션2는 select 쿼리를 실행해도 신규 회원들을 조회할 수 없다. 
- 여기서 헤깔릴 수 있는 것은 세션1이 select 쿼리를 실행해서 본인이 입력한 신규 회원1를 조회할 수 있다는 것이다.
<p align="center"><img src="https://user-images.githubusercontent.com/104331549/198904505-239d18d5-2131-450e-a9ab-e7687923f41d.png" width="80%"></p>

- 세션1이 신규 데이터를 추가한 후에 commit 을 호출했기에, 다른 세션에서도 회원 테이블을 조회하면 신규 회원을 확인할 수 있다.
<p align="center"><img src="https://user-images.githubusercontent.com/104331549/198904510-7f0ab931-9aa7-4e26-988c-990cd648c1d1.png" width="80%"></p>

- 만약, 세션1이 commit이 아닌 rollback를 호출했다면, 처음 상태로 복구 된다.
- 수정하거나 삭제한 데이터도 rollback 을 호출하면 모두 트랜잭션을 시작하기 직전의 상태로 복구된다.


<br></br>
<br></br>
# 트랜젝션 - 자동 커밋, 수동 커밋
### 자동커밋 
 - 각각의 쿼리 실행 직후에 자동으로 커밋을 호출한다. 
   - 따라서 커밋이나 롤백을 직접 호출하지 않아도 되는 편리함이 있다.
 - 하지만 쿼리를 하나하나 실행할 때 마다 자동으로 커밋이 되어버리기 때문에 우리가 원하는 트랜잭션 기능을 제대로 사용할 수 없다
```roomsql
set autocommit true; --자동 커밋 모드 설정
insert into member(member_id, money) values ('data1',10000); --자동 커밋
insert into member(member_id, money) values ('data2',10000); --자동 커밋
```
- 따라서 commit , rollback 을 직접 호출하면서 트랜잭션 기능을 제대로 수행하려면 자동 커밋을 끄고 수동 커밋을 사용해야 한다.

### 수동 커밋
 - 보통 자동 커밋 모드가 기본으로 설정된 경우가 많기 때문에, 수동 커밋 모드로 설정하는 것을 트랜잭션을 시작한다고 표현할 수 있다.
   - 한번 설정하면 해당 세션에서는 계속 유지된다.
 - 수동 커밋 설정을 하면 이후에 꼭 commit , rollback 을 호출해야 한다.
```roomsql
set autocommit false; --수동 커밋 모드 설정
insert into member(member_id, money) values ('data3',10000);
insert into member(member_id, money) values ('data4',10000);
commit; --수동 커밋
```

<br></br>
<br></br>

# 트랜잭션 - 실습

<a name=""></a>
<p align="center"><img src="" width="80%"></p>

## 느낀점 😌

### 참고 링크